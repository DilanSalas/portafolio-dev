---
import TranslateIcon from '../icons/TranslateIcon.astro';
---
<script is:inline>
  const DEFAULT_LANG = 'es';
  const SUPPORTED_LANGS = ['es', 'en'];
  const translationsCache = {};

  const getNestedValue = (obj, path) =>
    path.split('.').reduce((acc, part) => acc && acc[part], obj);

  const applyTranslations = (translations) => {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.dataset.i18n;
      const value = getNestedValue(translations, key);
      if (value) {
        el.innerHTML = value;
      }
    });
  };

  const loadLanguage = async (lang) => {
    if (!translationsCache[lang]) {
      const res = await fetch(`/locales/${lang}.json`);
      translationsCache[lang] = await res.json();
    }

    applyTranslations(translationsCache[lang]);
    document.documentElement.lang = lang;

    const label = document.getElementById('language-label');
    if (label) label.textContent = lang.toUpperCase();
  };

  const toggleLanguage = async () => {
    const current = localStorage.getItem('lang') || DEFAULT_LANG;
    const next = current === 'en' ? 'es' : 'en';
    localStorage.setItem('lang', next);
    await loadLanguage(next);
  };

  document.addEventListener('astro:page-load', async () => {
    const lang = localStorage.getItem('lang') || DEFAULT_LANG;
    localStorage.setItem('lang', lang);

    await loadLanguage(lang);

    document
      .querySelector('.language-switcher-container')
      ?.addEventListener('click', toggleLanguage);
  });
</script>

<div class="language-switcher-container fixed bottom-6 left-6 z-50">
  <div
    class="relative flex items-center justify-center w-16 h-16 rounded-full
           bg-white/60 dark:bg-black/60 cursor-pointer
           hover:ring-2 hover:ring-black dark:hover:ring-white
           transition-all duration-200"
  >
    <TranslateIcon class="w-6 h-6 text-black dark:text-white" />
    <span
      id="language-label"
      class="ml-1 font-semibold text-black dark:text-white"
    >
      ES
    </span>
  </div>
</div>
